<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="chat">

<!-- idx에 따라 알람테이블에 code 삽입 -->
 <insert id="addcode" parameterType="HashMap">
	insert into notification (not_UID, fk_idx, not_type, not_message, not_date, not_readcheck, not_remindstatus, not_time, not_URL)
	values(seq_notification_UID.nextval, 90, 5, #{code}, sysdate, default, default, default, 'http://localhost:9090/petopia/chat.pet')
</insert>

<!-- code에 따라 접속  -->
 <select id="viewcode" parameterType="String" resultType="String">
 	select not_message
	from notification
	where DBMS_LOB.INSTR(not_message, #{code})>0 and rownum = 1
 </select>

 
<!-- idx 값 가져오기 -->
 <select id="viewidx" parameterType="String" resultType="String">
    select substr(ltrim(not_message, '1234567890'),2) AS not_message
	from notification
	where fk_idx = 90 and rownum = 1
 </select>
 
<!-- idx에 따라 회원정보 가져오기 -->
  <select id="viewuserid" parameterType="String" resultType="String">
 	select userid 
	from
	(
	    select b.name as biz_name, docname
	    from member b join doctors D
	    on b.idx = d.fk_idx_biz
	    where b.idx= 90
	)
	join
	(
	    select userid
	    from member
	    where idx= #{idx}
	)
	on 1=1
 </select>
 
 <!-- idx에 따라 회원정보 가져오기 -->
  <select id="viewname_biz" parameterType="String" resultType="String">
 	select biz_name 
	from
	(
	    select b.name as biz_name, docname
	    from member b join doctors D
	    on b.idx = d.fk_idx_biz
	    where b.idx= 90
	)
	join
	(
	    select userid
	    from member
	    where idx= #{idx}
	)
	on 1=1
 </select>
 
 <!-- idx에 따라 회원정보 가져오기 -->
  <select id="viewdocname" parameterType="String" resultType="String">
 	select docname 
	from
	(
	    select b.name as biz_name, docname
	    from member b join doctors D
	    on b.idx = d.fk_idx_biz
	    where b.idx= 90
	)
	join
	(
	    select userid
	    from member
	    where idx= #{idx}
	)
	on 1=1
 </select>

 <insert id="insertall" parameterType="HashMap">
 	insert into video_advice(va_UID, fk_idx, fk_idx_biz, chatcode, fk_userid, fk_name_biz, fk_docname, Time)
	values(seq_video_advice_UID.nextval, #{idx}, 90, #{code}, #{fk_userid}, #{fk_name_biz}, #{fk_docname}, sysdate)
 </insert>
 
</mapper>