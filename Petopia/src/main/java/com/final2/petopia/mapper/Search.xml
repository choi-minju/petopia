<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="search">
	
	<select id="addrCount" parameterType="String" resultType="int">
		select count(*) as addrCnt
		from biz_info
		where addr1 like '%' || #{searchWord} || '%'
	</select>

	<select id="hsptalCount" parameterType="String" resultType="int">
		select count(*) as hsptalCnt
		from member M JOIN biz_info B
		on M.idx = B.idx_biz
		where membertype = 2 and biztype = 1 and name like '%' || #{searchWord} || '%'
	</select>

	<select id="pharmCount" parameterType="String" resultType="int">
		select count(*) as pharmCnt
		from member M JOIN biz_info B
		on M.idx = B.idx_biz
		where membertype = 2 and biztype = 2 and name like '%' || #{searchWord} || '%'
	</select>
	
	<select id="getFullnameAndIdx" parameterType="String" resultType="com.final2.petopia.model.Biz_MemberVO">
		select idx as idx_biz, name
		from biz_info B JOIN member M
		on B.idx_biz = M.idx
		where M.name like '%' || #{searchWord} || '%'
	</select>
	
	<select id="getBizmemListByword" parameterType="map" resultType="com.final2.petopia.model.Biz_MemberVO">		
		select distinct name, idx_biz, latitude, longitude, prontimg, startpoint as avg_startpoint
		from
		(
		select name, idx_biz, latitude, longitude, prontimg
		from biz_info B JOIN member M
		on B.idx_biz = M.idx
		FULL JOIN review R
		on M.idx = R.fk_idx_biz
		) V RIGHT JOIN 
		(
		select idx_biz as idx_biz2, nvl(round(avg(startpoint)), 0) as startpoint
		from biz_info B JOIN member M
		on B.idx_biz = M.idx
		FULL JOIN review R
		on M.idx = R.fk_idx_biz
		where 1=1 and 
		<if test="WHERENO == 1 || SEARCHWORD != null">
			B.addr1 like '%' || #{SEARCHWORD} || '%'
		</if>
		<if test="WHERENO == 2">
			<if test="SEARCHWORD != null">
			and
			</if>
			B.biztype = 1
		</if>
		<if test="WHERENO == 3">
			<if test="SEARCHWORD != null">
			and
			</if>
			B.biztype = 2
		</if>
		group by idx_biz
		) P
		on V.idx_biz = P.idx_biz2
		<if test="ORDERBYNO == 1"> <!-- 평점순 -->
			order by startpoint desc
		</if>
		<if test="ORDERBYNO == 2"> <!-- 거리순 -->
			order by ${STR_NUMBERS}
		</if>

	</select>
	
</mapper>